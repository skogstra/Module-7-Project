---
title: "Module 7 Project"
author: "Group 7"
date: "2023-10-30"
output: html_document
bibliography: BIOL3140.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(MuMIn)
library(dplyr)
```

# Introduction
The amount of force produced by muscle tissue is dependent on the relationship between the speed of contraction and the length of the muscle, but this project focuses specifically on the force-length relationship. We are isolating the human upper limb, specifically the forearm flexors, and how they respond to eccentric fatigue, in which tension is produced while the muscle is lengthening.

Eccentric exercise has been found to shift peak force to longer muscle lengths post-exercise, shifting the force-length relationship, as well [@butterfield2005]. This shift has been attributed to both muscle damage and fatigue following exercise [@butterfield2005]. By comparing the angle at which maximum force occurs between non-fatigued and eccentrically fatigued forearm flexors, we hope to gain a better understanding of force-length relationship under the influence of fatigue. 

When collecting our data, we are assuming that the force measured by the hand on the load sensor is representative of the force-length relationship of the input muscles. The isometric force of maximum voluntary contractions is recorded over a normal range of angles between the upper and lower arm. 


# Methods
To obtain force data, a set-up consisting of a 100-kg S-type Load Cell with HX711 amplifier and an Arduino Uno microcontroller was constructed. Using an Arduino sketch to obtain data, individuals performed isometric contractions at different angles when grabbing the handle of the Load Cell. The different angles ranged from 45° to 168.75° at 11.25° intervals, with a ganiometer being strapped to the arm at the elbow joint to see what angle the arm was making for each contraction. Contractions were held for as close to 30 seconds as possible before relaxing and moving on to the next angle. All twelve angles were tested in a single run before the bicep was eccentrically fatigued, lowering a heavy backpack repeatedly for three minutes to exhaust the muscle. After three minutes of fatiguing, the twelve angles were tested again in this fatigued state.


To normalize the unit-less data, the maximum force for each angle was found and each of these maxima was divided by the maximum force across all trials (including both control and fatigue). Once these relative 0-1 values were established, the shift in the maximum \theta between control and fatigue was determined along with the significance of the shift.

# Results
```{r load data, echo=F, message=F}
f <- list.files("new_data",pattern=".csv",full.names=T)

dat.l <- list()

for (i in f){
  met.dat<- unlist(strsplit(i,"_"))
  subject <- met.dat[3]
  activity <- met.dat[4]
  angle <- as.numeric(gsub(".csv","",met.dat[5]))
  dat.l[[i]]<- read_csv(i)%>%
    mutate(subject=subject,activity=activity,angle=angle)
}

dat <- do.call(rbind,dat.l)

dat <- dat %>%
  filter(!(subject=="letiacianna" | subject=="leticianna" & activity %in% c("fatigue", "control"))) %>%
  group_by(activity) %>%
  mutate(norm_force = abs(force/max(force)))
```

```{r AICcs, echo=F}
#Getting AICc scores for the three polynomial models
AICs <- dat%>%
  group_by(subject,activity) %>% 
  summarize(
    m2=AICc(lm(norm_force~poly(angle,2))),
    m3=AICc(lm(norm_force~poly(angle,3))), 
    m4=AICc(lm(norm_force~poly(angle,4)))
    )%>%
  pivot_longer(m2:m4,names_to="model",values_to="AICc")%>%
  print()
```

```{r pred, echo=F}
#Predicting values
x.pred <- seq(45,157.5,length.out = 1000)

fits <- dat%>%
  group_by(subject,activity)%>%
  summarize(
    m2=predict(lm(norm_force~poly(angle,2)),newdata=data.frame(angle=x.pred)),
    m3=predict(lm(norm_force~poly(angle,3)),newdata=data.frame(angle=x.pred)), 
    m4=predict(lm(norm_force~poly(angle,4)),newdata=data.frame(angle=x.pred)) 
  )%>%
   pivot_longer(m2:m4,names_to="model")%>%
   group_by(subject,activity,model)%>%
   summarize(theta_max=x.pred[which.max(value)])%>%
   print()
```

```{r best, echo=F}
#Joining AICs and fits tables to filter model predictions by best fitting model
best.models <- fits%>%
  left_join(AICs)%>%
  group_by(subject,activity) 

best.models %>% 
  mutate(best=AICc==min(AICc))%>%
  filter(best==TRUE)%>%
  dplyr::select(-best)%>%
  print()

anova(lm(theta_max~activity,best.models))
```

```{r mean_shift,  echo=F, message=F}
#Calculating mean shift with SEM
best.models %>%
  pivot_wider(id_cols=subject, names_from=activity, values_from=theta_max)%>%
  mutate(shift= fatigue-control) %>% 
  ungroup()%>%
  summarise(mean.shift=mean(shift),se.shift=sd(shift)/sqrt(length(shift)))
```

```{r graphs, echo=F}

```

# Discussion

# Author Contributions
Audrey: Methods
Ava:
Blake:
Conor: